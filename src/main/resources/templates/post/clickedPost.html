<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="fragments.html :: head"></head>

<body onload="gridLazyView()" class="bg-light">
<div id="contentPadding" style="height: 70px"></div>
<div th:replace="fragments.html :: nav-bar"></div>
<div th:replace="fragments.html :: off-canvas('post')"></div>
<div class="container">
  <div id="gridContent" class="row justify-content-center row-col-md-auto d-none mt-4" >
    <div class="col-3 d-none" id="side-bar-col" style="padding: 0px;" >
      <div th:replace="fragments.html :: side-bar('post')"></div>
    </div>
    <div class="col" id="content-col">
      <section>

        <article class="mx-1">
          <header>
            <div class="row">
              <div class="col-10">
                <img th:src="@{'/sections/' + ${post.belongedSectionType}}" class="rounded" width="20px" height="20px" />
                <small th:text="${post.belongedSectionType}"></small><small> · </small>
                <small th:text="${#temporals.format(post.createdDate, 'yyyy-MM-dd HH:mm')}"></small>
              </div>
              <div class="col-2 text-end">

                <div class="dropdown">
                  <button type="button" class="btn btn-light btn-sm" id="postDropdownMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="fa fa-ellipsis-h" aria-hidden="true"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-light text-small shadow" aria-labelledby="postDropdownMenuBtn">
                    <li><a class="dropdown-item" th:href="@{${DOWNLOAD_URL} + ${post.postImageUrl}}">download</a></li>
                    <li th:if="${profileMenu != null}"><a class="dropdown-item">delete</a></li>
                    <li th:if="${currentMenu != null}"><a href="#" class="dropdown-item">report</a></li>
                  </ul>
                </div>
              </div>
            </div>

            <div class="row">
              <div th:onclick="|vote('post', ${post.id}, true)|">
                <span class="col fw-bold fs-3 m-1" style="word-wrap: break-word;" th:text="${post.title}"></span>
              </div>
            </div>

            <div class="row justify-content-between">
              <div class="col-8 mt-2">
                <div sec:authorize="isAuthenticated()" th:id="${post.id}" style="display: inline">
                  <input type="button" id="upVoteBtn" class="btn btn-sm ms-1"  th:classappend="${upVotedIds.contains(post.id)} ? 'btn-primary' : 'btn-outline-primary'"
                         th:onclick="|vote('post', ${post.id}, true)|" th:value="'▲ ' + ${post.getVote().upVote}" />
                  <input type="button" id="downVoteBtn" class="btn btn-sm ms-1" th:classappend="${downVotedIds.contains(post.id)} ? 'btn-primary' : 'btn-outline-primary'"
                         th:onclick="|vote('post', ${post.id}, false)|" th:value="'▼ ' + ${post.getVote().downVote}" />
                </div>
                <div sec:authorize="!isAuthenticated()" th:id="${post.id}" style="display: inline">
                  <input type="button" id="upVoteBtn" class="btn btn-outline-primary btn-sm ms-1"
                         th:onclick="|window.location.href = @{/} + 'login'|" th:value="'▲ ' + ${post.getVote().upVote}" />
                  <input type="button" id="downVoteBtn" class="btn btn-outline-primary btn-sm ms-1"
                         th:onclick="|window.location.href = @{/} + 'login'|" th:value="'▼ ' + ${post.getVote().downVote}" />
                </div>
                <div style="display: inline">
                  <button type="button" class="btn btn-outline-primary btn-sm ms-1" th:onclick="|window.open(@{/} + 'post/' + ${post.id}, '_blank').focus()|">
                    <i class="fa fa-commenting" aria-hidden="true"></i>&nbsp;<span th:text="${post.commentCount}"></span>
                  </button>
                </div>
              </div>


              <div class="col-2 mt-2 me-1 text-end">
                <!-- TODO 공유기능 추가 -->
                <button type="button" class="btn btn-outline-primary btn-sm">
                  <i class="fa fa-share-alt" aria-hidden="true"></i>
                </button>
              </div>
            </div>
          </header>
          <picture>
            <div class="row justify-content-center rounded mt-2" style="background-color: #11111110; margin: 3px">
              <div class="col-auto">
                <video preload="metadata" muted autoplay loop th:if="${post.getContentType()} == 'mp4'" th:src="@{${FILE_URL} + ${post.postImageUrl}}"
                       style="min-width: 200px; width: 100%; max-width: 400px; height: auto; cursor: pointer;" onclick="toggleMute(this)"></video>
                <img th:if="${post.getContentType()} != 'mp4'" th:src="@{${FILE_URL} + ${post.postImageUrl}}" style="min-width: 200px; width: 100%; max-width: 400px; height: auto;">
              </div>
            </div>
          </picture>
          <span th:each="tag : ${tags}">
              <button type="button" class="btn btn-secondary btn-sm m-1" th:text="${tag}"></button>
            </span>
          <div class="ms-1 mt-4">
            <span th:text="${post.commentCount}" class="h5"></span>&nbsp;<span th:text="Comments" class="h5"></span>
          </div>
          <hr/>
        </article>
      </section>
      <section class="p-1">
        <div sec:authorize="isAuthenticated()">
          <div class="row mb-3">
            <div class="col-1">
                <svg th:if="${member.memberInfo.picImage} == null" th:data-jdenticon-value="${#authentication.name}"
                     width="30px" height="30px" class="rounded border bg-light"></svg>
                <img th:if="${member.memberInfo.picImage} != null" th:src="@{'/avatar/' + ${member.memberInfo.picImage}}"
                     width="30px" height="30px" class="rounded border"/>
            </div>
            <div class="col">
              <div th:replace="fragments.html :: commentForm"></div>
            </div>
          </div>
        </div>

        <div sec:authorize="!isAuthenticated()">
          <div class="row justify-content-between">
            <div class="col mt-1" th:text="#{comment.anonymous}">로그인으로 댓글남기기</div>
            <div class="col-4 mt-1 text-end">
              <button type="button" class="btn btn-secondary btn-sm" th:text="#{login}" th:onclick="|window.location.href = @{/} + 'login'|" style="display: inline"></button>
              <!--                <button type="button" class="btn btn-primary btn-sm" th:text="#{signup}" style="display: inline"></button>-->
            </div>
          </div>
        </div>

        <div th:each="comment : ${comments}">
          <div class="row">
            <!-- 아바타 -->
            <div class="col-1">
              <a class="round" th:href="@{'/user/'+${comment.commenterInfo.head}+'/home'}" href="#" role="button">
                <svg th:if="${comment.commenterInfo.getPicImage()} == null" th:data-jdenticon-value="${comment.commenterInfo.head}"
                     width="30px" height="30px" class="rounded border bg-light"></svg>
                <img th:href="@{'user/' + ${comment.commenterInfo.head} + '/home'}" th:if="${comment.commenterInfo.getPicImage()} != null" th:src="@{'/avatar/' + ${comment.commenterInfo.getPicImage()}}"
                     width="100%" height="auto" class="rounded border"/>
              </a>
            </div>
            <!-- 코맨트 -->
            <div class="col ms-1 mb-2">
              <span class="fw-bold" th:text="${comment.commenterInfo.head}"></span>
              <img th:if="${comment.commenterInfo.stateCode} != null" th:src="'https://lipis.github.io/flag-icon-css/flags/4x3/' + ${comment.commenterInfo.stateCode} + '.svg'"
                   style="width: 25px; height: 25px; vertical-align: text-bottom" class="rounded border">
              <div style="white-space: pre-line;" class="mt-2" th:text="${comment.content}"></div>
              <div th:if="${comment.descriptionImg} != null">
                <img th:src="@{'/comment/' + ${comment.descriptionImg}}" width="50%" class="rounded border"/>
              </div>
            </div>
            <!-- reply, upvote, downvote btn -->
            <div>
              <div sec:authorize="isAuthenticated()" style="display: inline">
                <a type="button" th:onclick="|reply(${comment.id})|">reply</a>
                <input type="button" id="upVoteCmtBtn" class="btn btn-sm ms-1" th:classappend="${upVoteCommentIds.contains(comment.id)} ? 'btn-primary' : 'btn-outline-primary'"
                       th:onclick="|vote('comment', ${comment.id}, true)|" th:value="'▲ ' + ${comment.getVote().upVote}" style="padding: 0px; margin: 0px; width: 40px; height: 20px;"/>
                <input type="button" id="downVoteCmtBtn" class="btn btn-sm ms-1" th:classappend="${downVoteCommentIds.contains(comment.id)} ? 'btn-primary' : 'btn-outline-primary'"
                       th:onclick="|vote('comment', ${comment.id}, false)|" th:value="'▼ ' + ${comment.getVote().downVote}" style="padding: 0px; margin: 0px; width: 40px; height: 20px;"/>
              </div>
              <div sec:authorize="!isAuthenticated()" th:id="${comment.id}" style="display: inline">
                <a type="button" th:onclick="|window.location.href = @{/} + 'login'|">reply</a>
                <input type="button" id="upVoteCmtBtn" class="btn btn-outline-primary btn-sm ms-1" style="padding: 0px; margin: 0px; width: 40px; height: 20px;"
                       th:onclick="|window.location.href = @{/} + 'login'|" th:value="'▲ ' + ${post.getVote().upVote}" />
                <input type="button" id="downVoteCmtBtn" class="btn btn-outline-primary btn-sm ms-1" style="padding: 0px; margin: 0px; width: 40px; height: 20px;"
                       th:onclick="|window.location.href = @{/} + 'login'|" th:value="'▼ ' + ${post.getVote().downVote}" />
              </div>
            </div>

            <!-- view # reply -->
            <!-- .replys after 추가 후 #viewMoreReplys 내용을 바꿔치기-->
            <a class="mb-3 ms-2 mt-1" th:if="*{comment.replyCount > 0}" style="text-decoration: none; cursor: pointer"
                    th:onclick="|viewReply(*{comment.id})|" id="replyArea">
              <i style="vertical-align: text-bottom" class="fa fa-caret-down" aria-hidden="true"></i>&nbsp;
              <span>view </span>
              <span th:text="*{comment.replyCount}"></span>
              <span> reply</span>
            </a>

            <!-- 대댓글쓰기 및 다른사람 댓글들 -->
            <div id="replySection" class="ps-5">
              <!-- 대댓글쓰기 -->
              <div sec:authorize="isAuthenticated()" th:id="'replyForm' + *{comment.id}" class="mt-3" style="width: 80%; height: 50%" hidden>
                <form class="needs-validation col-sm-6" action="#" th:object="${commentForm}" style="width: 100%"
                      th:action="@{'/reply/' +${post.id} + '/' + ${comment.id}}" method="post" enctype="multipart/form-data" novalidate>
                  <!-- 코멘트-->

                  <div class="input-group">
                    <span class="input-group-text">reply</span>
                    <textarea id="content" name="content" th:field="*{content}" style="height: 90px;" class="form-control" aria-label="With textarea" max="100"></textarea>
                    <small class="form-text text-danger" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">
                      빈파일 | 정의되지 않은 확장자
                    </small>
                  </div>

                  <div class="row justify-content-between">
                    <div class="col-5 ">
                      <!-- TODO 파일 선택 후 hidden 후 프리뷰 띄우기 -->
                      <div class="form-group">
                        <label class="btn btn-default p-0 mt-2">
                          <i class="fa fa-camera fa-lg" aria-hidden="true"></i>
                          <input type="file" name="file" style="white-space: pre-line;" id="file" th:accept="*{ACCEPTABLE_COMMENT_TYPES}"
                                 aria-describedby="fileHelp" th:field="*{file}" oninput="fileValidation()" hidden />
                        </label>
                      </div>

                    </div>
                    <div class="col mt-2 text-end">
                      <span class="btn btn-secondary btn-sm" type="button" th:onclick="|hideReplyForm(${comment.id})|" th:text="#{cancel}" style="display: inline">취소</span>
                      <div class="form-group" style="display: inline">
                        <button class="btn btn-primary btn-sm" type="submit" th:text="#{upload}">업로드</button>
                      </div>
                    </div>
                  </div>
                </form>
              </div>
              <!-- 대댓글 불러오기 -->
              <div th:id="'reply' + *{comment.id}">
              </div>
              <!-- 대댓글 더보기 -->
              <div id="viewMoreReplys" th:onclick="|viewReply(*{comment.id})|"></div>
            </div>
          </div>
        </div>
      </section>
    </div>
  </div>
  <script th:src="@{/node_modules/jdenticon/dist/jdenticon.min.js}"></script>
  <script th:replace="fragments.html :: ajax-csrf-header"></script>
  <script th:replace="fragments.html :: form-validation"></script>
  <script th:replace="fragments.html :: videoAutoPlay"></script>
  <script th:replace="fragments.html :: voteAjax"></script>
  <script>
    var viewReply = function (commentId) {
      var page = $('#reply' + commentId).children(".replyPageOffset").length;
      var contextPath = $('#contextPathHolder').attr('data-contextPath') ? $('#contextPathHolder').attr('data-contextPath') : '';

      $.ajax({
        method: "GET",
        url: contextPath + '/reply/slice/' + commentId + '/' + page,
        processData: false,
      }).done(function (reply) {
          $('#reply' + commentId).append(reply);
        });
    }
    var reply = function (id) {
      document.getElementById('replyForm' + id).removeAttribute('hidden');
    }

    var hideReplyForm = function (id){
      document.getElementById('replyForm' + id).setAttribute('hidden', '');
    }
  </script>
</div>
</body>
</html>